import React, { useState } from 'react';
import { PiggyBank, DollarSign, Calendar, ChevronDown, ChevronUp, Info } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

const DEFAULT_VALUES = {
  currentHomeValue: 1500000,
  newHomeValue: 800000,
  currentSuper: 600000,
  salaryForSuper: 150000,
  currentAge: 55,
  currentSavings: 500000,
  annualExpenses: 80000,
  expectedReturn: 5,
  superReturnRate: 7,
  inflationRate: 2.5
};

const CONSTANTS = {
  TRADITIONAL_RETIREMENT_AGE: 67,
  SUPER_CONTRIBUTION_CAP: 27500,
  SAFE_WITHDRAWAL_RATE: 0.04,
  SUPER_PRESERVATION_AGE: 60,
  ASSET_TEST_THRESHOLD: 585750,
  BASE_PENSION_AMOUNT: 25000,
};

const formatCurrency = (value) => {
  return new Intl.NumberFormat('en-AU', {
    style: 'currency',
    currency: 'AUD',
    maximumFractionDigits: 0,
  }).format(value);
};

const Input = ({ icon: Icon, label, value, onChange, min, max, step = 1 }) => (
  <div>
    <label className="block text-sm font-medium mb-1">
      {label}
    </label>
    <div className="relative">
      {Icon && <Icon className="absolute left-2 top-2.5 w-4 h-4 text-gray-500" />}
      <input
        type="number"
        value={value}
        onChange={(e) => onChange(parseFloat(e.target.value) || 0)}
        min={min}
        max={max}
        step={step}
        className={`${Icon ? 'pl-8' : ''} w-full p-2 border rounded`}
      />
    </div>
  </div>
);

const RetirementCalculator = () => {
  const [inputs, setInputs] = useState(DEFAULT_VALUES);
  const [showAdvanced, setShowAdvanced] = useState(false);
  const [showMath, setShowMath] = useState(false);

  const calculateRetirement = () => {
    const capitalFreed = Math.max(0, inputs.currentHomeValue - inputs.newHomeValue);
    const totalInvestableCapital = capitalFreed + inputs.currentSavings;
    const yearsToTraditionalRetirement = Math.max(0, CONSTANTS.TRADITIONAL_RETIREMENT_AGE - inputs.currentAge);
    
    const annualSuperContribution = Math.min(
      CONSTANTS.SUPER_CONTRIBUTION_CAP,
      inputs.salaryForSuper * 0.115
    );
    
    const realInvestmentReturn = Math.max(0, (inputs.expectedReturn - inputs.inflationRate) / 100);
    const realSuperReturn = Math.max(0, (inputs.superReturnRate - inputs.inflationRate) / 100);
    
    let yearsToRetirement = 0;
    let investedCapital = totalInvestableCapital;
    let currentSuper = inputs.currentSuper;
    
    const calculateRetirementReadiness = (capital, superBalance, age) => {
      const canAccessSuper = age >= CONSTANTS.SUPER_PRESERVATION_AGE;
      const incomeFromCapital = capital * CONSTANTS.SAFE_WITHDRAWAL_RATE;
      const incomeFromSuper = canAccessSuper ? superBalance * CONSTANTS.SAFE_WITHDRAWAL_RATE : 0;
      let estimatedAgePension = 0;
      
      if ((capital + superBalance) < CONSTANTS.ASSET_TEST_THRESHOLD) {
        estimatedAgePension = CONSTANTS.BASE_PENSION_AMOUNT;
      }
      
      return (incomeFromCapital + incomeFromSuper + estimatedAgePension) >= inputs.annualExpenses;
    };
    
    while (yearsToRetirement < yearsToTraditionalRetirement) {
      const projectedAge = inputs.currentAge + yearsToRetirement;
      
      if (calculateRetirementReadiness(investedCapital, currentSuper, projectedAge)) {
        break;
      }
      
      investedCapital *= (1 + realInvestmentReturn);
      currentSuper = (currentSuper + annualSuperContribution) * (1 + realSuperReturn);
      yearsToRetirement++;
      
      if (yearsToRetirement >= 50) break;
    }
    
    const projectedSuper = inputs.currentSuper * 
      Math.pow(1 + realSuperReturn, yearsToTraditionalRetirement) +
      annualSuperContribution * 
      ((Math.pow(1 + realSuperReturn, yearsToTraditionalRetirement) - 1) / realSuperReturn);

    const retirementAge = inputs.currentAge + yearsToRetirement;
    const canAccessSuper = retirementAge >= CONSTANTS.SUPER_PRESERVATION_AGE;
    const monthlyIncomeFromCapital = (investedCapital * CONSTANTS.SAFE_WITHDRAWAL_RATE) / 12;
    const monthlyIncomeFromSuper = canAccessSuper ? (currentSuper * CONSTANTS.SAFE_WITHDRAWAL_RATE) / 12 : 0;
    const monthlyIncome = monthlyIncomeFromCapital + monthlyIncomeFromSuper;

    return {
      capitalFreed,
      monthlyIncome,
      projectedSuper,
      yearsEarlier: Math.max(0, yearsToTraditionalRetirement - yearsToRetirement),
      combinedWealth: currentSuper + investedCapital,
      retirementAge,
      canAccessSuper,
      currentSuper
    };
  };

  const results = calculateRetirement();

  return (
    <div className="max-w-4xl mx-auto p-4">
      <Card>
        <CardContent className="p-6">
          <CardTitle className="text-2xl font-bold mb-6 flex items-center gap-2">
            <PiggyBank className="w-6 h-6" />
            Australian Downsizing & Super Calculator
          </CardTitle>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Input Section */}
            <div className="space-y-4">
              {/* Property Details */}
              <div className="bg-blue-50 p-4 rounded-lg">
                <h3 className="font-semibold mb-4">Property Details</h3>
                <div className="space-y-4">
                  <Input
                    icon={DollarSign}
                    label="Current Home Value"
                    value={inputs.currentHomeValue}
                    onChange={(value) => setInputs({ ...inputs, currentHomeValue: value })}
                    min={0}
                    step={10000}
                  />
                  <Input
                    icon={DollarSign}
                    label="Downsized Home Value"
                    value={inputs.newHomeValue}
                    onChange={(value) => setInputs({ ...inputs, newHomeValue: value })}
                    min={0}
                    step={10000}
                  />
                </div>
              </div>

              {/* Super Details */}
              <div className="bg-green-50 p-4 rounded-lg">
                <h3 className="font-semibold mb-4">Superannuation Details</h3>
                <div className="space-y-4">
                  <Input
                    icon={PiggyBank}
                    label="Current Super Balance"
                    value={inputs.currentSuper}
                    onChange={(value) => setInputs({ ...inputs, currentSuper: value })}
                    min={0}
                    step={10000}
                  />
                  <Input
                    icon={DollarSign}
                    label="Annual Salary (for Super)"
                    value={inputs.salaryForSuper}
                    onChange={(value) => setInputs({ ...inputs, salaryForSuper: value })}
                    min={0}
                    step={1000}
                  />
                </div>
              </div>

              {/* Basic Info */}
              <Input
                icon={Calendar}
                label="Current Age"
                value={inputs.currentAge}
                onChange={(value) => setInputs({ ...inputs, currentAge: value })}
                min={18}
                max={100}
              />

              {/* Advanced Options Toggle */}
              <button
                className="flex items-center gap-2 text-blue-600 text-sm"
                onClick={() => setShowAdvanced(!showAdvanced)}
              >
                {showAdvanced ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
                {showAdvanced ? 'Hide Advanced Options' : 'Show Advanced Options'}
              </button>

              {/* Advanced Options */}
              {showAdvanced && (
                <div className="space-y-4">
                  <Input
                    icon={DollarSign}
                    label="Current Non-Super Savings"
                    value={inputs.currentSavings}
                    onChange={(value) => setInputs({ ...inputs, currentSavings: value })}
                    min={0}
                    step={10000}
                  />
                  <Input
                    icon={DollarSign}
                    label="Annual Living Expenses"
                    value={inputs.annualExpenses}
                    onChange={(value) => setInputs({ ...inputs, annualExpenses: value })}
                    min={0}
                    step={1000}
                  />
                  <Input
                    label="Expected Investment Return (%)"
                    value={inputs.expectedReturn}
                    onChange={(value) => setInputs({ ...inputs, expectedReturn: value })}
                    min={0}
                    max={20}
                    step={0.1}
                  />
                  <Input
                    label="Super Return Rate (%)"
                    value={inputs.superReturnRate}
                    onChange={(value) => setInputs({ ...inputs, superReturnRate: value })}
                    min={0}
                    max={20}
                    step={0.1}
                  />
                  <Input
                    label="Inflation Rate (%)"
                    value={inputs.inflationRate}
                    onChange={(value) => setInputs({ ...inputs, inflationRate: value })}
                    min={0}
                    max={10}
                    step={0.1}
                  />
                </div>
              )}

              {/* Math Toggle */}
              <button
                className="flex items-center gap-2 text-blue-600 text-sm mt-4"
                onClick={() => setShowMath(!showMath)}
              >
                <Info className="w-4 h-4" />
                {showMath ? 'Hide Calculation Details' : 'Show Calculation Details'}
              </button>

              {/* Math Details */}
              {showMath && (
                <div className="bg-gray-50 p-4 rounded-lg text-sm space-y-2">
                  <h4 className="font-semibold">How the Calculations Work:</h4>
                  <div className="space-y-3">
                    <p>1. <strong>Super Contributions:</strong> Uses current 11.5% employer contribution rate, capped at $27,500 annually.</p>
                    <p>2. <strong>Investment Returns:</strong> All returns are adjusted for inflation (real returns).</p>
                    <p>3. <strong>Retirement Income:</strong> Uses the 4% safe withdrawal rule from super and investments.</p>
                    <p>4. <strong>Age Pension:</strong> Considers basic asset test thresholds ($585,750 for single homeowner).</p>
                    <p>5. <strong>Early Retirement:</strong> Calculates earliest point where combined income from super (if accessible) and investments meets expenses.</p>
                  </div>
                </div>
              )}
            </div>

            {/* Results Section */}
            <div className="bg-gray-50 p-6 rounded-lg">
              <h3 className="text-xl font-semibold mb-4">Retirement Projections</h3>
              <div className="space-y-6">
                <div>
                  <p className="text-sm text-gray-600">Capital Released from Downsizing</p>
                  <p className="text-2xl font-bold text-green-600">
                    {formatCurrency(results.capitalFreed)}
                  </p>
                </div>

                <div className="border-t pt-4">
                  <p className="text-sm text-gray-600">Monthly Income at Retirement</p>
                  <p className="text-2xl font-bold text-blue-600">
                    {formatCurrency(results.monthlyIncome)}
                  </p>
                </div>

                <div className="border-t pt-4">
                  <h4 className="font-semibold mb-2">Traditional Retirement (Age 67)</h4>
                  <div>
                    <p className="text-sm text-gray-600">Projected Super Balance</p>
                    <p className="text-xl font-semibold">
                      {formatCurrency(results.projectedSuper)}
                    </p>
                  </div>
                </div>

                <div className="border-t pt-4">
                  <h4 className="font-semibold mb-2">Early Retirement Scenario</h4>
                  <div className="space-y-2">
                    <div>
                      <p className="text-sm text-gray-600">Years Earlier You Could Retire</p>
                      <p className="text-2xl font-bold text-blue-600">
                        {results.yearsEarlier.toFixed(1)} years
                      </p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-600">Combined Wealth at Early Retirement</p>
                      <p className="text-xl font-semibold">
                        {formatCurrency(results.combinedWealth)}
                      </p>
                    </div>
                  </div>
                </div>

                <div className="mt-4 p-4 bg-blue-50 rounded-lg space-y-3">
                  <h4 className="font-semibold">Key Insights:</h4>
                  <div className="space-y-2 text-sm">
                    <p>1. <strong>Downsizing Impact:</strong> By downsizing from {formatCurrency(inputs.currentHomeValue)} to {formatCurrency(inputs.newHomeValue)}, 
                    you free up {formatCurrency(results.capitalFreed)} to invest.</p>
                    
                    <p>2. <strong>Investment Growth:</strong> This freed-up capital could generate approximately 
                    {formatCurrency(results.capitalFreed * CONSTANTS.SAFE_WITHDRAWAL_RATE)} in annual passive income (using the 4% rule).</p>
                    
                    <p>3. <strong>Super Growth:</strong> Your super could grow from {formatCurrency(inputs.currentSuper)} to 
                    {formatCurrency(results.currentSuper)} by your early retirement date (age {Math.round(results.retirementAge)}).</p>
                    
                    <p>4. <strong>Monthly Income:</strong> At retirement, you could have {formatCurrency(results.monthlyIncome)} monthly income 
                    from your combined super{results.canAccessSuper ? '' : ' (when accessible)'} and investment sources.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

export default RetirementCalculator;
